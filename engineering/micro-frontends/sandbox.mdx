import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# æ²™ç®±

## å‰è¨€

å½“å¤šä¸ªå­åº”ç”¨ç‹¬ç«‹è¿è¡Œæ—¶ï¼Œæ¯ä¸ªåº”ç”¨éƒ½ä¼šæœ‰è‡ªå·±çš„è¿è¡Œç¯å¢ƒï¼Œè¿™çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œå¯¹å§ã€‚ä½†æ˜¯è¿è¡Œåœ¨**å®¿ä¸»åº”ç”¨** é‡Œåº”ç”¨ï¼Œéœ€è¦å¦‚ä½•é¿å…è‡ªèº«çš„ç¯å¢ƒè¢« **å®¿ä¸»åº”ç”¨** å½±å“ï¼Œæˆ–è€…å½±å“ **å®¿ä¸»åº”ç”¨**ï¼Œå³ **åº”ç”¨é—´è¿è¡Œæ—¶å¦‚ä½•ç›¸äº’éš”ç¦»**ï¼Œæ¯”å¦‚è¯´å¸¸è§çš„å¦‚ä½•å®ç° JS éš”ç¦»ï¼ŒCSS éš”ç¦»ã€‚

ä¸€èˆ¬çš„ï¼Œå¸¸è§çš„æ–¹æ¡ˆä¼šæœ‰ä¸‹é¢è¿™äº›ï¼š

-   åŸºäº iframe + æ¶ˆæ¯é€šä¿¡çš„å®ç°
-   åŸºäº Proxy å¿«ç…§å­˜å‚¨ + window ä¿®æ”¹çš„å®ç°
-   åŸºäº Proxy ä»£ç†æ‹¦æˆª + window æ¿€æ´»/å¸è½½çš„å®ç°
-   åŸºäºæ™®é€šå¯¹è±¡å¿«ç…§å­˜å‚¨çš„ window å±æ€§ diff å®ç°
-   åŸºäº [ShadowRealm](https://github.com/tc39/proposal-shadowrealm) ææ¡ˆçš„å®ç°
-   åŸºäº with + eval çš„ç®€å•å®ç°
-   Webpack 5 Module Federation(æ¨¡å—è”é‚¦)

## ä¸ºä»€ä¹ˆä¸é€‰æ‹© iframe

```ts
const iframe = document.createElement('iframe', {src: 'about:blank'});
document.body.appendChild(iframe);
const sandboxGlobal = iframe.contentWindow;
```

[iframe sandbox](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/iframe#attr-sandbox)

:::tip [å¼•ç”¨ Why Not Iframe](https://www.yuque.com/kuitos/gky7yw/gesexv)
iframe æœ€å¤§çš„ç‰¹æ€§å°±æ˜¯æä¾›äº†æµè§ˆå™¨åŸç”Ÿçš„ç¡¬éš”ç¦»æ–¹æ¡ˆï¼Œä¸è®ºæ˜¯æ ·å¼éš”ç¦»ã€js éš”ç¦»è¿™ç±»é—®é¢˜ç»Ÿç»Ÿéƒ½èƒ½è¢«å®Œç¾è§£å†³ã€‚ä½†ä»–çš„æœ€å¤§é—®é¢˜ä¹Ÿåœ¨äºä»–çš„éš”ç¦»æ€§æ— æ³•è¢«çªç ´ï¼Œå¯¼è‡´åº”ç”¨é—´ä¸Šä¸‹æ–‡æ— æ³•è¢«å…±äº«ï¼Œéšä¹‹å¸¦æ¥çš„å¼€å‘ä½“éªŒã€äº§å“ä½“éªŒçš„é—®é¢˜ã€‚

1. url ä¸åŒæ­¥ã€‚æµè§ˆå™¨åˆ·æ–° iframe url çŠ¶æ€ä¸¢å¤±ã€åé€€å‰è¿›æŒ‰é’®æ— æ³•ä½¿ç”¨ã€‚**(å¥½è§£å†³)**
2. UI ä¸åŒæ­¥ï¼ŒDOM ç»“æ„ä¸å…±äº«ã€‚æƒ³è±¡ä¸€ä¸‹å±å¹•å³ä¸‹è§’ 1/4 çš„ iframe é‡Œæ¥ä¸€ä¸ªå¸¦é®ç½©å±‚çš„å¼¹æ¡†ï¼ŒåŒæ—¶æˆ‘ä»¬è¦æ±‚è¿™ä¸ªå¼¹æ¡†è¦æµè§ˆå™¨å±…ä¸­æ˜¾ç¤ºï¼Œè¿˜è¦æµè§ˆå™¨ resize æ—¶è‡ªåŠ¨å±…ä¸­ã€‚ **(éš¾ä»¥è§£å†³)**
3. å…¨å±€ä¸Šä¸‹æ–‡å®Œå…¨éš”ç¦»ï¼Œå†…å­˜å˜é‡ä¸å…±äº«ã€‚iframe å†…å¤–ç³»ç»Ÿçš„é€šä¿¡ã€æ•°æ®åŒæ­¥ç­‰éœ€æ±‚ï¼Œä¸»åº”ç”¨çš„ cookie è¦é€ä¼ åˆ°æ ¹åŸŸåéƒ½ä¸åŒçš„å­åº”ç”¨ä¸­å®ç°å…ç™»æ•ˆæœã€‚**(éš¾ä»¥è§£å†³)**
4. æ…¢ã€‚æ¯æ¬¡å­åº”ç”¨è¿›å…¥éƒ½æ˜¯ä¸€æ¬¡æµè§ˆå™¨ä¸Šä¸‹æ–‡é‡å»ºã€èµ„æºé‡æ–°åŠ è½½çš„è¿‡ç¨‹ï¼ŒåŠ è½½ä¼˜åŒ–ã€è¿è¡Œä¼˜åŒ–é—®é¢˜ **(å¥½è§£å†³)**

:::

## ä¸ºä»€ä¹ˆä¸é€‰æ‹© Module Federation

Module Federation æ”¯æŒå¤šä¸ªç‹¬ç«‹çš„æ„å»ºå¯ä»¥ç»„æˆä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œè¿™äº›ç‹¬ç«‹çš„æ„å»ºä¹‹é—´ä¸åº”è¯¥å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå› æ­¤å¯ä»¥å•ç‹¬å¼€å‘å’Œéƒ¨ç½²å®ƒä»¬ã€‚

è¿™ä¸ªæ–¹æ¡ˆä¸­æœ‰ä¸¤ä¸ªä¸»ä½“ï¼š Remote å’Œ Host ï¼Œå¯ä»¥æŠŠ Remote ç†è§£ä¸ºæƒ³è¦å¼•å…¥çš„å­åº”ç”¨ï¼ŒæŠŠ Host ç†è§£ä¸ºä¸»åº”ç”¨ ä¸­çš„ä½œç”¨åŸŸï¼ˆscope) åªæœ‰å…¨å±€ä½œç”¨åŸŸï¼ˆglobal scope) ã€å‡½æ•°ä½œç”¨åŸŸï¼ˆfunction scope) ä»¥åŠä» ES6 å¼€å§‹æ‰æœ‰çš„å—çº§ä½œç”¨åŸŸï¼ˆblock scope) ã€‚ä½†æ˜¯ä¸€ä¸ªåº”ç”¨æ—¢å¯ä»¥æ˜¯ Remote ä¹Ÿå¯ä»¥æ˜¯ Hostï¼Œå¹¶ä¸çŸ›ç›¾) ã€‚

ä½†æ˜¯å¦‚æœæ¥å…¥çš„åº”ç”¨å¯¹ **shared ä¾èµ–åŒ…** æœ‰å¼ºä¾èµ–å…³ç³»ï¼Œå°±æ²¡åŠæ³•ä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œå¿…é¡»ä¿æŒä¸€è‡´ã€‚

Module Federation çš„æ ¸å¿ƒåœ¨äº ModuleFederationPlugin è¿™ä¸ªæ’ä»¶ï¼š

```ts
new ModuleFederationPlugin({
    name: 'App1',
    library: {type: 'var', name: 'App1'},
    filename: 'remoteEntry.js',
    remotes: {
        app_02: 'App2',
        app_03: 'App3',
    },
    exposes: {
        antd: './src/antd',
        button: './src/button',
    },
    shared: ['react', 'react-dom'],
});
```

-   nameï¼Œå¿…é¡»ï¼Œå”¯ä¸€ IDï¼Œä½œä¸ºè¾“å‡ºçš„æ¨¡å—åï¼Œä½¿ç”¨çš„æ—¶é€šè¿‡ name/{expose}çš„æ–¹å¼ä½¿ç”¨ï¼›
-   libraryï¼Œå¿…é¡»ï¼Œå…¶ä¸­è¿™é‡Œçš„ name ä¸ºä½œä¸º umd çš„ nameã€‚
-   remotesï¼Œå¯é€‰ï¼Œè¡¨ç¤ºä½œä¸º Host æ—¶ï¼Œå»æ¶ˆè´¹å“ªäº› Remoteã€‚
-   exposesï¼Œå¯é€‰ï¼Œè¡¨ç¤ºä½œä¸º Remote æ—¶ï¼Œexport å“ªäº›å±æ€§è¢«æ¶ˆè´¹ã€‚
-   sharedï¼Œå¯é€‰ï¼Œä¼˜å…ˆç”¨ Host çš„ä¾èµ–ï¼Œå¦‚æœ Host æ²¡æœ‰ï¼Œå†ç”¨è‡ªå·±çš„ã€‚

## å®šä¹‰

åˆç§°ä¸º sandbox, æŒ‡ä¸€ä¸ªå…è®¸ä½ ç‹¬ç«‹è¿è¡Œç¨‹åºçš„è™šæ‹Ÿç¯å¢ƒã€‚å®ƒèƒ½å¤Ÿæœ‰æ•ˆåœ°éš”ç¦»ã€æ”¶é›†ã€æ¸…é™¤åº”ç”¨åœ¨è¿è¡ŒæœŸé—´æ‰€äº§ç”Ÿçš„å‰¯ä½œç”¨ï¼Œä¿è¯ **å½“å‰æ‰§è¡Œç¯å¢ƒ** ä½œç”¨åŸŸå’Œ **å¤–éƒ¨** å…¶ä»–ä½œç”¨åŸŸç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ã€‚

æ¯”å¦‚è¯´å…¨å±€å˜é‡ã€å…¨å±€äº‹ä»¶ã€å®šæ—¶å™¨ã€ç½‘ç»œè¯·æ±‚ã€localStorageã€Style æ ·å¼ã€DOM å…ƒç´ ã€‚

## æ²™ç›’çš„ä¼˜åŠ¿

-   å¼€å‘è€…ä½“éªŒä¸åˆ°ç¯å¢ƒçš„åŒºåˆ«
-   è¿è¡Œæ²¡æœ‰ç¯å¢ƒå·®å¼‚

## åˆ†ç±»

ä¸€èˆ¬çš„åˆ†ä¸º **å¿«ç…§æ²™ç®±** å’Œ **VM æ²™ç®±**ã€‚

### äºŒè€…å¯¹æ¯”

| ç‰¹æ€§ | å¿«ç…§ | VM |
|--------|:--------:|:--------:|
|å­åº”ç”¨ä¹‹é—´éš”ç¦»| âœ… | âœ… |
|ä¸»å­åº”ç”¨éš”ç¦»| âŒ | âœ… |
|å˜é‡éš”ç¦»| âœ… | âœ… |
|æ ·å¼éš”ç¦»| âŒ | âœ… |
|å¤šå®ä¾‹éš”ç¦»| âœ… | âœ… |

:::warning å‰ç½®
é€šè¿‡ [Garfish](https://github.com/modern-js-dev/garfish) çš„å®ç°åŸç†æ¥åˆ†æï¼Œæ¬¢è¿å’Œæˆ‘ä¸€èµ·çœ‹ä»£ç 
:::

### å¿«ç…§æ²™ç®±

å®ƒä¸»è¦æ˜¯é€šè¿‡å¯¹å…¨å±€çš„ **window å˜é‡** è¿›è¡Œæ“ä½œï¼Œå¤§è‡´æ‰§è¡Œæ­¥éª¤æ˜¯

1. å­˜å‚¨å½“å‰æ‰§è¡Œç¯å¢ƒ
2. æ‰§è¡Œå…·å¤‡æœ‰å‰¯ä½œç”¨çš„ä»£ç 
3. æ¢å¤æ‰§è¡Œç¯å¢ƒ

code path: `packages/browser-snapshot/src/sandbox.ts:L31`

#### CSS

```ts
// packages/browser-snapshot/src/patchers/style.ts
export class PatchStyle {
    private domSnapshotBefore!: Snapshot;
    private domSnapshotMutated!: SnapshotDiff | null;

    public activate() {
        // è®°å½•å½“å‰domèŠ‚ç‚¹ã€æ¢å¤ä¹‹å‰domèŠ‚ç‚¹å‰¯ä½œç”¨
        this.domSnapshotBefore = Snapshot.take();

        if (this.domSnapshotMutated)
            this.headInterceptor.add(
                this.domSnapshotMutated.created,
                this.domSnapshotMutated.removed
            );
    }

    public deactivate() {
        // æ¢å¤æ²™ç›’è¿è¡Œå‰domèŠ‚ç‚¹ç¯å¢ƒï¼Œå¹¶å°†å·®å¼‚å€¼è¿›è¡Œç¼“å­˜
        const domSnapshot = Snapshot.take();
        this.domSnapshotMutated = domSnapshot.diff(this.domSnapshotBefore);

        if (!this.domSnapshotMutated) return;
        this.headInterceptor.remove(
            this.domSnapshotMutated.created,
            this.domSnapshotMutated.removed
        );
    }

    // ...
}
```

#### JS

```ts
const hasOwnProperty = Object.prototype.hasOwnProperty;
function hasOwn(obj: any, key: PropertyKey): boolean {
    return hasOwnProperty.call(obj, key);
}

export class PatchGlobalVal {
    public snapshotOriginal = new Map();
    private snapshotMutated: any = new Map();

    // ...

    // 1. Trigger hooks, life cycle willActivate enabled (going to)
    // 2. Will disable the current group of other box, and triggers the switch life cycle
    // 3. The current window object properties for caching
    // 4. Restore the sandbox side effects during operation
    // 1. è§¦å‘é’©ï¼Œç”Ÿå‘½å‘¨æœŸå°† willActivate å¯ç”¨
    // 2. å°†ç¦ç”¨å½“å‰çš„å…¶ä»–ç›’å­ï¼Œå¹¶è§¦å‘å¼€å…³ç”Ÿå‘½å‘¨æœŸ
    // 3. å½“å‰çª—å£å¯¹è±¡å±æ€§ç”¨äºç¼“å­˜
    // 4. è¿è¡Œè¿‡ç¨‹ä¸­çš„æ²™ç›’å‰¯ä½œç”¨
    public activate() {
        // Recorded before the global environment, restore side effects of a variable
        this.safeIterator((i: string) => {
            this.snapshotOriginal.set(i, this.targetToProtect[i]);
        });

        this.snapshotMutated.forEach((val, mutateKey) => {
            this.targetToProtect[mutateKey] = this.snapshotMutated.get(mutateKey);
        });
    }

    // 1. åœ¨å¯åŠ¨å˜é‡æ›´æ”¹æœŸé—´çš„æ²™ç®±ï¼Œè®°å½•å˜æ›´è®°å½•
    // 2. åœ¨å¯åŠ¨æœŸé—´æ”¾ç½®æ²™ç®±ä»¥åˆ é™¤å˜é‡ï¼Œè®°å½•å˜æ›´è®°å½•
    // 1. Restore the sandbox during startup variables change, record the change record
    // 2. Restore the sandbox during startup to delete variables, record the change record
    public deactivate() {
        const deleteMap: any = {};
        const updateMap: any = {};
        const addMap: any = {};

        // Restore the sandbox before running Windows properties of environment, and difference value for caching
        this.safeIterator((normalKey: string) => {
            if (this.snapshotOriginal.get(normalKey) !== (this.targetToProtect[normalKey] as any)) {
                this.snapshotMutated.set(normalKey, this.targetToProtect[normalKey]); // deleted key will be defined as undefined on
                this.targetToProtect[normalKey] = this.snapshotOriginal.get(normalKey); // || this.targetToProtect[i]

                // Collection of delete, modify variables
                if (this.targetToProtect[normalKey] === undefined) {
                    addMap[normalKey] = this.snapshotMutated.get(normalKey);
                } else {
                    updateMap[normalKey] = this.snapshotMutated.get(normalKey);
                }
            }
            this.snapshotOriginal.delete(normalKey);
        });

        this.snapshotOriginal.forEach((val, deleteKey) => {
            this.snapshotMutated.set(deleteKey, this.targetToProtect[deleteKey]);
            this.targetToProtect[deleteKey] = this.snapshotOriginal.get(deleteKey);
            deleteMap[deleteKey] = this.targetToProtect[deleteKey];
        });
    }

    // ...
}
```

### VM æ²™ç®±

#### åŸç†

åœ¨ JavaScript ä¸­çš„ä½œç”¨åŸŸåªæœ‰å…¨å±€ä½œç”¨åŸŸï¼ˆglobal scopeï¼‰ã€å‡½æ•°ä½œç”¨åŸŸï¼ˆfunction scopeï¼‰ä»¥åŠä» ES6 å¼€å§‹æ‰æœ‰çš„å—çº§ä½œç”¨åŸŸï¼ˆblock scopeï¼‰ã€‚

å¦‚æœè¦å°†ä¸€æ®µä»£ç ä¸­çš„å˜é‡ã€å‡½æ•°ç­‰çš„å®šä¹‰éš”ç¦»å‡ºæ¥ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€šè¿‡è¿™ä¹ˆå‡ ç§æ–¹å¼æ¥è¾¾åˆ°ç›®çš„ï¼š
```mdx-code-block
<Tabs>
<TabItem value='IIFE'>
```
:::note è‡ªæ‰§è¡Œå‡½æ•°

å½“å‡½æ•°å˜æˆç«‹å³æ‰§è¡Œçš„å‡½æ•°è¡¨è¾¾å¼æ—¶ï¼Œè¡¨è¾¾å¼ä¸­çš„å˜é‡ä¸èƒ½ä»å¤–éƒ¨è®¿é—®ï¼Œå®ƒæ‹¥æœ‰ç‹¬ç«‹çš„è¯æ³•ä½œç”¨åŸŸã€‚ä¸ä»…é¿å…äº†å¤–ç•Œè®¿é—® IIFE ä¸­çš„å˜é‡ï¼Œè€Œä¸”åˆä¸ä¼šæ±¡æŸ“å…¨å±€ä½œç”¨åŸŸï¼Œå¼¥è¡¥äº† JavaScript åœ¨ scope æ–¹é¢çš„ç¼ºé™·ã€‚

```ts
(function foo(){
  const name = 'Rain120';

  console.log(name);
})();
```
:::

```mdx-code-block
</TabItem>
<TabItem value='eval'>
```

:::note [eval](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/eval) å‡½æ•°å¯å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºä»£ç æ‰§è¡Œï¼Œå¹¶è¿”å›ä¸€ä¸ªæˆ–å¤šä¸ªå€¼

```ts
const user = eval(
  "({name: 'Rain120'})"
);
console.log(user.name);
```

Note:

[æ°¸è¿œä¸è¦ä½¿ç”¨ evalï¼](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/eval#don.27t_use_eval.21)

:::

```mdx-code-block
</TabItem>
<TabItem value='new Function'>
```

:::note [Function](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function) æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ Function å¯¹è±¡ã€‚ç›´æ¥è°ƒç”¨è¿™ä¸ªæ„é€ å‡½æ•°å¯ç”¨äºåŠ¨æ€åˆ›å»ºå‡½æ•°ã€‚

```ts
const getUser = new Function(
  "console.log({name: 'Rain120'})"
);
console.log(getUser());
```

Note:

- ä¸èƒ½è®¿é—®å½“å‰ç¯å¢ƒå˜é‡ï¼Œä½†å¯ä»¥è®¿é—®å…¨å±€å˜é‡ï¼Œå®‰å…¨æ€§é«˜
- åªéœ€è¦å¤„ç†ä¼ å…¥çš„å­—ç¬¦ä¸²ä¸€æ¬¡ï¼Œåé¢é‡å¤æ‰§è¡Œéƒ½æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œè€Œevaléœ€è¦æ¯æ¬¡éƒ½å¤„ç†ï¼Œæ€§èƒ½æ›´é«˜

:::

```mdx-code-block
</TabItem>
<TabItem value='with'>
```

:::note [with](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/with): æ‰©å±•ä¸€ä¸ªè¯­å¥çš„ä½œç”¨åŸŸé“¾

```ts
var a, x, y;
var r = 10;

with (Math) {
  a = PI * r * r;
  x = r * cos(PI);
  y = r * sin(PI / 2);
}
```

Note:

- withè¯­å¥å¯ä»¥åœ¨ä¸é€ æˆæ€§èƒ½æŸå¤±çš„æƒ…æ³ä¸‹ï¼Œå‡å°‘å˜é‡çš„é•¿åº¦ã€‚
- withè¯­å¥ä½¿å¾—ç¨‹åºåœ¨æŸ¥æ‰¾å˜é‡å€¼æ—¶ï¼Œéƒ½æ˜¯å…ˆåœ¨æŒ‡å®šçš„å¯¹è±¡ä¸­æŸ¥æ‰¾ã€‚(with æ˜¯é€šè¿‡ in æ¥åˆ¤æ–­æ˜¯å¦åœ¨å½“å‰ä½œç”¨åŸŸå†…çš„)

:::

```mdx-code-block
</TabItem>
</Tabs>
```

#### CSS

```mdx-code-block
<Tabs>
<TabItem value='style'>
```

```ts
// highlight-next-line
// packages/browser-vm/src/dynamicNode/processor.ts:L315
// ...

// The style node needs to be placed in the sandbox root container
else if (this.is('style')) {
  parentNode = this.findParentNodeInApp(context, 'head');

  // highlight-start
  const manager = new StyleManager(this.el.textContent);
  manager.correctPath(baseUrl);
  // highlight-end

  if (styleScopeId) {
    manager.setScope({
      appName: namespace,
      rootElId: styleScopeId(),
    });
  }
  this.el.textContent = manager.transformCode(manager.styleCode);
  convertedNode = this.el;

  // highlight-next-line
  this.sandbox.dynamicStyleSheetElementSet.add(this.el);
  this.monitorChangesOfStyle();
}
```

```mdx-code-block
</TabItem>
<TabItem value='link'>
```

```ts
// highlight-next-line
// packages/browser-vm/src/dynamicNode/processor.ts:L331
// ...

// The link node of the request css needs to be changed to style node
else if (this.is('link')) {
  parentNode = this.findParentNodeInApp(context, 'head');
  if (this.el.rel === 'stylesheet' && this.el.href) {
    // highlight-start
    convertedNode = this.addDynamicLinkNode((styleNode) =>
      this.nativeAppend.call(parentNode, styleNode),
    );
    // highlight-end
  } else {
    convertedNode = this.el;
    this.monitorChangesOfLinkNode();
  }
}
```

```mdx-code-block
</TabItem>
<TabItem value='é‡æ–°æŒ‚è½½ & å¸è½½CSS Rules'>
```

```ts
// highlight-next-line
// packages/browser-vm/src/dynamicNode/index.ts:L142
export function recordStyledComponentCSSRules(
    dynamicStyleSheetElementSet: Set<HTMLStyleElement>,
    styledComponentCSSRulesMap: WeakMap<HTMLStyleElement, CSSRuleList>
) {
    dynamicStyleSheetElementSet.forEach(styleElement => {
        if (isStyledComponentsLike(styleElement) && styleElement.sheet) {
            // highlight-start
            styledComponentCSSRulesMap.set(styleElement, styleElement.sheet.cssRules);
            // highlight-end
        }
    });
}

export function rebuildCSSRules(
    dynamicStyleSheetElementSet: Set<HTMLStyleElement>,
    styledComponentCSSRulesMap: WeakMap<HTMLStyleElement, CSSRuleList>
) {
    dynamicStyleSheetElementSet.forEach(styleElement => {
        const cssRules = styledComponentCSSRulesMap.get(styleElement);
        if (cssRules && (isStyledComponentsLike(styleElement) || cssRules.length)) {
            for (let i = 0; i < cssRules.length; i++) {
                const cssRule = cssRules[i];
                // highlight-start
                // re-insert rules for styled-components element
                styleElement.sheet?.insertRule(
                    cssRule.cssText,
                    styleElement.sheet?.cssRules.length
                );
                // highlight-end
            }
        }
    });
}
```

```mdx-code-block
</TabItem>
</Tabs>
```

#### JS

```mdx-code-block
<Tabs>
<TabItem value='Execute Script'>
```

```ts
// highlight-next-line
// packages/browser-vm/src/dynamicNode/processor.tsï¼šL139

// Load dynamic js script
private addDynamicScriptNode() {
  const { src, type, crossOrigin } = this.el;
  const isModule = type === 'module';
  const code = this.el.textContent || this.el.text || '';

  if (!type || isJsType({ src, type })) {
    // The "src" higher priority
    const { baseUrl, namespace } = this.sandbox.options;
    if (src) {
      const fetchUrl = baseUrl ? transformUrl(baseUrl, src) : src;
      this.sandbox.loader
        .load<JavaScriptManager>({
          scope: namespace,
          url: fetchUrl,
          crossOrigin,
          defaultContentType: type,
        })
        .then(
          (manager) => {
            if (manager.resourceManager) {
              const {
                resourceManager: { url, scriptCode },
              } = manager;
              // highlight-start
              // ğŸ‘‡ğŸ» å¿…é¡»å–åˆ°æ‰§è¡Œä»£ç æ—¶ä¸ä¼šè§¦å‘åˆ° `el.onerror` äº‹ä»¶
              // It is necessary to ensure that the code execution error cannot trigger the `el.onerror` event
              // æ‰§è¡Œå¹¶åŠ«æŒ script code
              this.sandbox.execScript(scriptCode, {}, url, {
                isModule,
                noEntry: true,
              });
              // highlight-end
            } else {
              warn(
                `Invalid resource type "${type}", "${src}" can't generate scriptManager`,
              );
            }
            this.dispatchEvent('load');
          },
          (e) => {
            __DEV__ && warn(e);
            this.dispatchEvent('error', {
              error: e,
              filename: fetchUrl,
            });
          },
        );
    } else if (code) {
      // highlight-start
      this.sandbox.execScript(code, {}, baseUrl, { noEntry: true });
      // highlight-end
    }
    // highlight-start
    // ğŸ‘‡ğŸ» ç¡®ä¿å·²åˆ é™¤æ­£å¸¸çš„å¤„ç†èŠ‚ç‚¹
    // To ensure the processing node to normal has been removed
    // ä»¥æ³¨é‡Šçš„å½¢å¼æ’å…¥å­å®¹å™¨ä¸­
    const scriptCommentNode = this.DOMApis.createScriptCommentNode({
      src,
      code,
    });
    // highlight-end
    this.el[__REMOVE_NODE__] = () =>
      this.DOMApis.removeElement(scriptCommentNode);
    return scriptCommentNode;
  }
  return this.el;
}
```

```mdx-code-block
</TabItem>
</Tabs>
```

## å‚è€ƒèµ„æ–™

[Webpack 5 Module Federation(æ¨¡å—è”é‚¦)](https://webpack.js.org/concepts/module-federation/)

[ä¸€æ–‡å½»åº•ææ‡‚å‰ç«¯æ²™ç®±](https://mp.weixin.qq.com/s/9uABusnrO-IDpXk3EFmdWA)
